class EventManager{constructor(){this.events=new Map,this.onceEvents=new Map}on(e,t,i=null){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push({callback:t,context:i})}once(e,t,i=null){this.onceEvents.has(e)||this.onceEvents.set(e,[]),this.onceEvents.get(e).push({callback:t,context:i})}off(e,t){if(this.events.has(e)){const i=this.events.get(e),s=i.findIndex(e=>e.callback===t);s>-1&&i.splice(s,1)}}emit(e,t=null){if(this.events.has(e)){this.events.get(e).forEach(({callback:i,context:s})=>{try{i.call(s,t)}catch(t){console.error(`Error in event listener for ${e}:`,t)}})}if(this.onceEvents.has(e)){this.onceEvents.get(e).forEach(({callback:i,context:s})=>{try{i.call(s,t)}catch(t){console.error(`Error in once event listener for ${e}:`,t)}}),this.onceEvents.delete(e)}}clear(e){this.events.delete(e),this.onceEvents.delete(e)}clearAll(){this.events.clear(),this.onceEvents.clear()}}class VideoSource extends EventManager{constructor({url:e,config:t}){super(),this.url=e,this.config=t,this.videoElement=null,this.isLoaded=!1}async load(){return new Promise((e,t)=>{this.videoElement=this.config.container.querySelector(".up-video"),this.videoElement?(this.setupEventListeners(),this.videoElement.src=this.url,this.videoElement.addEventListener("loadeddata",()=>{this.isLoaded=!0,e()},{once:!0}),this.videoElement.addEventListener("error",e=>{t(new Error(`Video load error: ${e.message}`))},{once:!0})):t(new Error("Video element not found"))})}setupEventListeners(){["loadstart","loadedmetadata","loadeddata","canplay","canplaythrough","play","pause","ended","timeupdate","volumechange","seeking","seeked","waiting","playing","progress","error"].forEach(e=>{this.videoElement.addEventListener(e,t=>{this.handleVideoEvent(e,t)})})}handleVideoEvent(e,t){const i=this.extractEventData(e,t);this.emit(e,i)}extractEventData(e,t){const i={currentTime:this.videoElement.currentTime,duration:this.videoElement.duration,volume:this.videoElement.volume,muted:this.videoElement.muted,paused:this.videoElement.paused,ended:this.videoElement.ended,buffered:this.getBufferedRanges()};switch(e){case"error":return{...i,error:t.target.error};case"progress":return{...i,loaded:this.getLoadedRanges()};default:return i}}getBufferedRanges(){const e=this.videoElement.buffered,t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}getLoadedRanges(){return this.getBufferedRanges()}async play(){if(!this.videoElement)throw new Error("Video not loaded");return this.videoElement.play()}pause(){this.videoElement&&this.videoElement.pause()}seek(e){this.videoElement&&(this.videoElement.currentTime=e)}setVolume(e){this.videoElement&&(this.videoElement.volume=Math.max(0,Math.min(1,e)))}setMuted(e){this.videoElement&&(this.videoElement.muted=e)}setPlaybackRate(e){this.videoElement&&(this.videoElement.playbackRate=e)}setQuality(e){console.log(`Basic video source doesn't support quality switching to ${e}`)}loadUrl(e){this.url=e,this.videoElement&&(this.videoElement.src=e)}supportsPiP(){return"pictureInPictureEnabled"in document&&document.pictureInPictureEnabled}async togglePictureInPicture(){if(!this.supportsPiP()||!this.videoElement)throw new Error("Picture-in-Picture not supported");document.pictureInPictureElement?await document.exitPictureInPicture():await this.videoElement.requestPictureInPicture()}getState(){return this.videoElement?{currentTime:this.videoElement.currentTime,duration:this.videoElement.duration,volume:this.videoElement.volume,muted:this.videoElement.muted,paused:this.videoElement.paused,ended:this.videoElement.ended,playbackRate:this.videoElement.playbackRate,readyState:this.videoElement.readyState,networkState:this.videoElement.networkState}:null}destroy(){this.videoElement&&(this.videoElement.pause(),this.videoElement.src="",this.videoElement.load()),this.clearAll(),this.videoElement=null,this.isLoaded=!1}}class AudioSource extends VideoSource{constructor({url:e,config:t}){super({url:e,config:t}),this.mediaType="audio"}async load(){return new Promise((e,t)=>{this.audioElement=document.createElement("audio"),this.audioElement.className="up-audio",this.audioElement.preload="metadata";const i=this.config.container.querySelector(".up-player"),s=i.querySelector(".up-video");s&&(i.replaceChild(this.audioElement,s),this.videoElement=this.audioElement),this.setupEventListeners(),this.audioElement.src=this.url,this.audioElement.addEventListener("loadeddata",()=>{this.isLoaded=!0,e()},{once:!0}),this.audioElement.addEventListener("error",e=>{t(new Error(`Audio load error: ${e.message}`))},{once:!0})})}supportsPiP(){return!1}async togglePictureInPicture(){throw new Error("Picture-in-Picture not supported for audio")}setQuality(e){console.log(`Audio source doesn't support quality switching to ${e}`)}}class DASHSource extends VideoSource{constructor({url:e,config:t}){super({url:e,config:t}),this.dashPlayer=null,this.qualities=[],this.currentQuality="auto"}async load(){return new Promise(async(e,t)=>{try{if(this.dashPlayer=await this.createDASHInstance(),this.videoElement=this.config.container.querySelector(".up-video"),!this.videoElement)return void t(new Error("Video element not found"));this.setupEventListeners(),this.setupDASHEvents(),await this.dashPlayer.initialize(this.videoElement,this.url),this.extractQualities(),this.isLoaded=!0,e()}catch(e){t(e)}})}async createDASHInstance(){return{initialize:async(e,t)=>(console.log(`Initializing DASH player with ${t}`),e.src=t,Promise.resolve()),on:(e,t)=>{setTimeout(()=>{"streamInitialized"===e&&t()},1e3)},getBitrateInfoListFor:e=>[{qualityIndex:0,bitrate:5e6,width:1920,height:1080},{qualityIndex:1,bitrate:25e5,width:1280,height:720},{qualityIndex:2,bitrate:12e5,width:854,height:480},{qualityIndex:3,bitrate:8e5,width:640,height:360}],setQualityFor:(e,t)=>{console.log(`Setting ${e} quality to index ${t}`)},getQualityFor:e=>0,setAutoSwitchQualityFor:(e,t)=>{console.log(`Auto quality ${t?"enabled":"disabled"} for ${e}`)},destroy:()=>{console.log("DASH player destroyed")}}}setupDASHEvents(){this.dashPlayer&&(this.dashPlayer.on("qualityChangeRendered",e=>{const t=e.newQuality;this.currentQuality=this.qualities[t]?.name||"auto",this.emit("quality_changed",{quality:this.currentQuality})}),this.dashPlayer.on("bufferStateChanged",e=>{this.emit("buffering",{buffering:"bufferStalled"===e.state})}),this.dashPlayer.on("streamInitialized",()=>{this.extractQualities()}))}extractQualities(){if(!this.dashPlayer)return;const e=this.dashPlayer.getBitrateInfoListFor("video");this.qualities=[{name:"auto",index:-1},...e.map((e,t)=>({name:`${e.height}p`,index:e.qualityIndex,height:e.height,width:e.width,bitrate:e.bitrate}))]}setQuality(e){if(this.dashPlayer){if("auto"===e)this.dashPlayer.setAutoSwitchQualityFor("video",!0),this.currentQuality="auto";else{const t=this.qualities.find(t=>t.name===e);if(!t)return void console.log(`Quality ${e} not found`);this.dashPlayer.setAutoSwitchQualityFor("video",!1),this.dashPlayer.setQualityFor("video",t.index),this.currentQuality=e}console.log(`Quality set to ${e}`),this.emit("quality_changed",{quality:e})}else console.log("DASH player not initialized")}getQualities(){return this.qualities.map(e=>e.name)}getCurrentQuality(){return this.currentQuality}destroy(){this.dashPlayer&&(this.dashPlayer.destroy(),this.dashPlayer=null),super.destroy(),this.qualities=[],this.currentQuality="auto"}}class HLSSource extends VideoSource{constructor({url:e,config:t}){super({url:e,config:t}),this.hls=null,this.qualities=[],this.currentQuality="auto"}async load(){return this.videoElement&&this.videoElement.canPlayType("application/vnd.apple.mpegurl")?this.loadNativeHLS():this.loadHLSjs()}async loadNativeHLS(){return new Promise((e,t)=>{this.videoElement=this.config.container.querySelector(".up-video"),this.videoElement?(this.setupEventListeners(),this.videoElement.src=this.url,this.videoElement.addEventListener("loadeddata",()=>{this.isLoaded=!0,e()},{once:!0}),this.videoElement.addEventListener("error",e=>{t(new Error(`HLS load error: ${e.message}`))},{once:!0})):t(new Error("Video element not found"))})}async loadHLSjs(){return new Promise(async(e,t)=>{try{if(this.hls=await this.createHLSInstance(),this.videoElement=this.config.container.querySelector(".up-video"),!this.videoElement)return void t(new Error("Video element not found"));this.setupEventListeners(),this.setupHLSEvents(),this.hls.loadSource(this.url),this.hls.attachMedia(this.videoElement),this.hls.on("MANIFEST_PARSED",()=>{this.extractQualities(),this.isLoaded=!0,e()}),this.hls.on("ERROR",(e,i)=>{i.fatal&&t(new Error(`HLS fatal error: ${i.type} - ${i.details}`))})}catch(e){t(e)}})}async createHLSInstance(){return{loadSource:e=>{console.log(`Loading HLS source: ${e}`)},attachMedia:e=>{console.log("Attaching HLS to video element"),e.src=this.url},on:(e,t)=>{"MANIFEST_PARSED"===e&&setTimeout(()=>t(),1e3)},levels:[{height:1080,bitrate:5e6,name:"1080p"},{height:720,bitrate:25e5,name:"720p"},{height:480,bitrate:12e5,name:"480p"},{height:360,bitrate:8e5,name:"360p"}],currentLevel:-1,destroy:()=>{console.log("HLS instance destroyed")}}}setupHLSEvents(){this.hls&&(this.hls.on("LEVEL_SWITCHED",(e,t)=>{console.log(`Quality switched to level ${t.level}`),this.currentQuality=this.qualities[t.level]?.name||"auto",this.emit("quality_changed",{quality:this.currentQuality})}),this.hls.on("BUFFER_APPENDING",()=>{this.emit("buffering",{buffering:!0})}),this.hls.on("BUFFER_APPENDED",()=>{this.emit("buffering",{buffering:!1})}))}extractQualities(){this.hls&&this.hls.levels&&(this.qualities=[{name:"auto",level:-1},...this.hls.levels.map((e,t)=>({name:e.name||`${e.height}p`,level:t,height:e.height,bitrate:e.bitrate}))])}setQuality(e){if(!this.hls)return void console.log("HLS not initialized");const t=this.qualities.find(t=>t.name===e);t?(this.hls.currentLevel=t.level,this.currentQuality=e,console.log(`Quality set to ${e}`),this.emit("quality_changed",{quality:e})):console.log(`Quality ${e} not found`)}getQualities(){return this.qualities.map(e=>e.name)}getCurrentQuality(){return this.currentQuality}destroy(){this.hls&&(this.hls.destroy(),this.hls=null),super.destroy(),this.qualities=[],this.currentQuality="auto"}}class Mp4Source extends VideoSource{constructor({url:e,config:t}){super({url:e,config:t}),this.qualities=["auto"],this.currentQuality="auto"}async load(){return new Promise((e,t)=>{this.videoElement=this.config.container.querySelector(".up-video"),this.videoElement?(this.setupEventListeners(),this.videoElement.src=this.url,this.videoElement.addEventListener("loadeddata",()=>{this.isLoaded=!0,e()},{once:!0}),this.videoElement.addEventListener("error",e=>{t(new Error(`MP4 load error: ${e.message}`))},{once:!0})):t(new Error("Video element not found"))})}setQuality(e){console.log(`MP4 source doesn't support quality switching. Requested: ${e}`)}getQualities(){return this.qualities}getCurrentQuality(){return this.currentQuality}destroy(){this.videoElement&&(this.videoElement.pause(),this.videoElement.src="",this.videoElement.load()),this.clearAll(),this.videoElement=null,this.isLoaded=!1,this.qualities=["auto"],this.currentQuality="auto"}}class MediaFactory{constructor(){this.sourceTypes=new Map([["video",VideoSource],["audio",AudioSource],["hls",HLSSource],["mp4",Mp4Source],["dash",DASHSource]])}createMediaSource({url:e,type:t,config:i}){const s=t||this.detectMediaType(e,i),n=this.sourceTypes.get(s);if(!n)throw new Error(`Unsupported media type: ${s}`);return new n({url:e,config:i})}detectMediaType(e,t){if(t.priority)return t.priority;const i=e.toLowerCase();return i.includes(".m3u8")||i.includes("hls")?"hls":i.includes(".mpd")||i.includes("dash")?"dash":i.match(/\.(mp3|wav|aac|ogg)(\?|$)/)?"audio":(i.match(/\.(mp4|webm|flv|avi|mov)(\?|$)/),"video")}registerSourceType(e,t){this.sourceTypes.set(e,t)}getSupportedTypes(){return Array.from(this.sourceTypes.keys())}}class UIManager extends EventManager{constructor({container:e,config:t,playerId:i}){super(),this.container=e,this.config=t,this.playerId=i,this.playerElement=null,this.videoElement=null,this.controlsElement=null,this.playButton=null,this.progressBar=null,this.volumeSlider=null,this.timeDisplay=null,this.controlsVisible=!0,this.isFullscreen=!1,this.hideTimeout=null,this.isMobile=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}async build(){this.createPlayerStructure(),this.createControls(),this.applyTheme(),this.setupEventListeners(),this.setupControlsAutoHide()}createPlayerStructure(){this.container.innerHTML="",this.container.className="universal-player-container",this.playerElement=document.createElement("div"),this.playerElement.className="up-player",this.playerElement.setAttribute("data-player-id",this.playerId),this.videoElement=document.createElement("video"),this.videoElement.className="up-video",this.config.poster&&(this.videoElement.poster=this.config.poster),this.videoElement.preload="metadata",this.videoElement.playsinline=!0,this.config.vertical&&this.playerElement.classList.add("up-vertical"),this.playerElement.appendChild(this.videoElement),this.container.appendChild(this.playerElement)}createControls(){this.controlsElement=document.createElement("div"),this.controlsElement.className="up-controls",this.createProgressBar();const e=document.createElement("div");e.className="up-control-bar";const t=document.createElement("div");t.className="up-controls-left",this.createPlayButton(t),this.createVolumeControls(t),this.createTimeDisplay(t);const i=document.createElement("div");i.className="up-controls-center";const s=document.createElement("div");s.className="up-controls-right",this.createQualityButton(s),this.createSpeedButton(s),this.createPipButton(s),this.createFullscreenButton(s),e.appendChild(t),e.appendChild(i),e.appendChild(s),this.controlsElement.appendChild(this.progressBar),this.controlsElement.appendChild(e),this.config.features.topBar&&this.createTopBar(),this.createOverlayElements(),this.playerElement.appendChild(this.controlsElement)}createProgressBar(){this.progressBar=document.createElement("div"),this.progressBar.className="up-progress-container";const e=document.createElement("div");e.className="up-progress-track";const t=document.createElement("div");t.className="up-progress-buffer";const i=document.createElement("div");i.className="up-progress-fill";const s=document.createElement("div");s.className="up-progress-handle",e.appendChild(t),e.appendChild(i),e.appendChild(s),this.progressBar.appendChild(e);let n=!1;const a=t=>{const i=e.getBoundingClientRect(),s=(t.clientX-i.left)/i.width*(this.videoElement.duration||0);this.emit("ui:seek",{time:s})};e.addEventListener("mousedown",e=>{n=!0,a(e)}),document.addEventListener("mousemove",e=>{n&&a(e)}),document.addEventListener("mouseup",()=>{n=!1}),e.addEventListener("touchstart",e=>{n=!0;const t=e.touches[0];a(t)}),e.addEventListener("touchmove",e=>{if(n){e.preventDefault();const t=e.touches[0];a(t)}}),e.addEventListener("touchend",()=>{n=!1})}createPlayButton(e){this.playButton=document.createElement("button"),this.playButton.className="up-btn up-play-btn",this.playButton.innerHTML=this.getPlayIcon(),this.playButton.setAttribute("aria-label","Play"),this.playButton.addEventListener("click",()=>{this.videoElement.paused?this.emit("ui:play"):this.emit("ui:pause")}),e.appendChild(this.playButton)}createVolumeControls(e){if(!this.config.features.volume)return;const t=document.createElement("div");t.className="up-volume-container";const i=document.createElement("button");i.className="up-btn up-volume-btn",i.innerHTML=this.getVolumeIcon(1,!1),i.setAttribute("aria-label","Mute"),i.addEventListener("click",()=>{this.emit("ui:mute")}),this.volumeSlider=document.createElement("input"),this.volumeSlider.type="range",this.volumeSlider.className="up-volume-slider",this.volumeSlider.min="0",this.volumeSlider.max="1",this.volumeSlider.step="0.1",this.volumeSlider.value="1",this.volumeSlider.addEventListener("input",e=>{this.emit("ui:volume",{volume:parseFloat(e.target.value)})}),t.appendChild(i),t.appendChild(this.volumeSlider),e.appendChild(t)}createTimeDisplay(e){(this.config.ui.showCurrentTime||this.config.ui.showDuration)&&(this.timeDisplay=document.createElement("div"),this.timeDisplay.className="up-time-display",this.timeDisplay.textContent="0:00 / 0:00",e.appendChild(this.timeDisplay))}createQualityButton(e){if(!this.config.features.qualityInControlBar)return;const t=document.createElement("button");t.className="up-btn up-quality-btn",t.innerHTML="HD",t.setAttribute("aria-label","Quality"),t.addEventListener("click",()=>{this.showQualityMenu()}),e.appendChild(t)}createSpeedButton(e){if(!this.config.features.speed)return;const t=document.createElement("button");t.className="up-btn up-speed-btn",t.innerHTML="1x",t.setAttribute("aria-label","Playback Speed"),t.addEventListener("click",()=>{this.showSpeedMenu()}),e.appendChild(t)}createPipButton(e){if(!this.config.features.pip)return;const t=document.createElement("button");t.className="up-btn up-pip-btn",t.innerHTML=this.getPipIcon(),t.setAttribute("aria-label","Picture in Picture"),t.addEventListener("click",()=>{this.emit("ui:pip")}),e.appendChild(t)}createFullscreenButton(e){const t=document.createElement("button");t.className="up-btn up-fullscreen-btn",t.innerHTML=this.getFullscreenIcon(!1),t.setAttribute("aria-label","Fullscreen"),t.addEventListener("click",()=>{this.emit("ui:fullscreen")}),e.appendChild(t)}createTopBar(){const e=document.createElement("div");if(e.className="up-top-bar",this.config.theme.customLogo){const t=document.createElement("img");t.src=this.config.theme.customLogo,t.className="up-logo",e.appendChild(t)}this.controlsElement.appendChild(e)}createOverlayElements(){const e=document.createElement("div");e.className="up-spinner",e.innerHTML=this.getSpinnerIcon(),this.playerElement.appendChild(e);const t=document.createElement("button");t.className="up-big-play-btn",t.innerHTML=this.getPlayIcon(),t.addEventListener("click",()=>{this.emit("ui:play")}),this.playerElement.appendChild(t)}applyTheme(){const{customColor:e}=this.config.theme;e&&this.playerElement.style.setProperty("--up-primary-color",e)}setupEventListeners(){this.playerElement.addEventListener("click",e=>{e.target!==this.videoElement&&e.target!==this.playerElement||(this.videoElement.paused?this.emit("ui:play"):this.emit("ui:pause"))}),this.playerElement.addEventListener("keydown",e=>{this.handleKeyboard(e)}),this.playerElement.addEventListener("mousemove",()=>{this.showControls()}),this.playerElement.addEventListener("mouseleave",()=>{this.hideControls()})}setupControlsAutoHide(){if(this.config.ui.controlsAlwaysVisible)return;const e=()=>{this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>{this.videoElement.paused||this.hideControls()},this.config.ui.hideControlsTimeout)};this.playerElement.addEventListener("mousemove",e),this.playerElement.addEventListener("touchstart",e)}handleKeyboard(e){switch(e.code){case"Space":e.preventDefault(),this.videoElement.paused?this.emit("ui:play"):this.emit("ui:pause");break;case"ArrowLeft":e.preventDefault(),this.emit("ui:seek",{time:Math.max(0,this.videoElement.currentTime-10)});break;case"ArrowRight":e.preventDefault(),this.emit("ui:seek",{time:Math.min(this.videoElement.duration,this.videoElement.currentTime+10)});break;case"KeyF":e.preventDefault(),this.emit("ui:fullscreen");break;case"KeyM":e.preventDefault(),this.emit("ui:mute")}}updatePlayButton(e){const t=this.config.container.querySelector(".up-big-play-btn");this.playButton&&(this.playButton.innerHTML=e?this.getPauseIcon():this.getPlayIcon(),this.playButton.setAttribute("aria-label",e?"Pause":"Play")),t&&(t.style.display=e?"none":"block",t.innerHTML=e?this.getPauseIcon():this.getPlayIcon())}updateProgress(e,t){if(!this.progressBar||!t)return;const i=e/t*100,s=this.progressBar.querySelector(".up-progress-fill");s&&(s.style.width=`${i}%`),this.timeDisplay&&(this.timeDisplay.textContent=`${this.formatTime(e)} / ${this.formatTime(t)}`)}updateVolume(e,t){this.volumeSlider&&(this.volumeSlider.value=e);const i=this.playerElement.querySelector(".up-volume-btn");i&&(i.innerHTML=this.getVolumeIcon(e,t))}showBuffering(e){const t=this.playerElement.querySelector(".up-spinner");t&&(t.style.display=e?"block":"none")}showControls(){this.controlsElement.classList.add("up-controls-visible"),this.controlsVisible=!0}hideControls(){this.videoElement.paused||(this.controlsElement.classList.remove("up-controls-visible"),this.controlsVisible=!1)}showQualityMenu(){console.log("Quality menu would appear here")}showSpeedMenu(){console.log("Speed menu would appear here")}getPlayIcon(){return"‚ñ∂"}getPauseIcon(){return"‚è∏"}getVolumeIcon(e,t){return t||0===e?"üîá":e<.5?"üîâ":"üîä"}getFullscreenIcon(e){return e?"‚è∑":"‚õ∂"}getPipIcon(){return"‚ßâ"}getSpinnerIcon(){return"‚ü≥"}formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}destroy(){this.hideTimeout&&clearTimeout(this.hideTimeout),this.clearAll(),this.container&&(this.container.innerHTML="")}}class ConfigManager{constructor(){this.defaultConfig={videoUrl:"",poster:"",autoplay:!1,startOffset:0,vertical:!1,locale:"en",priority:"hls",container:null,features:{speed:!0,nextVideo:!0,volume:!0,pip:!0,chromecast:!1,qualityInControlBar:!0,topBar:!0,share:!1,oneHand:!1,cinema:!0,ccVisible:!0},hlsConfig:{maxBufferLength:30,maxInitialBufferLength:6,prebufferGoal:3,enableWorker:!0,lowLatencyMode:!1},hotspots:[],menu:{related:[],showOnPause:!0,slideout:!1},theme:{customColor:"#FF6B00",customLogo:"",themeCode:"default"},pip:{enabled:!0,position:"bottom-right",size:{width:320,height:180}},eventTracking:{enabled:!1,cdn:"unknown",isp:"unknown",geo:"unknown",videoId:"",playerSource:"universal-player",viewedThreshold:.8,trackingUrl:""},nextVideo:{enabled:!0,url:"",title:"",poster:"",countdown:10},adRolls:{preRoll:null,postRoll:null,pauseRoll:null},isVr:!1,vrProps:{},ui:{hideControlsTimeout:3e3,showThumbnails:!0,showDuration:!0,showCurrentTime:!0,controlsAlwaysVisible:!1},quality:{default:"auto",levels:["auto","1080p","720p","480p","360p","240p"]},speed:{default:1,options:[.25,.5,.75,1,1.25,1.5,1.75,2]},volume:1,muted:!1,subtitles:{enabled:!1,tracks:[],defaultLanguage:"en"}}}createConfig(e={}){return this.deepMerge(this.defaultConfig,e)}deepMerge(e,t){const i={...e};for(const e in t)t.hasOwnProperty(e)&&(this.isObject(t[e])&&this.isObject(i[e])?i[e]=this.deepMerge(i[e],t[e]):i[e]=t[e]);return i}isObject(e){return e&&"object"==typeof e&&!Array.isArray(e)}validateConfig(e){const t=[];if(e.videoUrl||t.push("videoUrl is required"),e.startOffset&&(e.startOffset<0||!Number.isFinite(e.startOffset))&&t.push("startOffset must be a positive number"),e.volume&&(e.volume<0||e.volume>1)&&t.push("volume must be between 0 and 1"),t.length>0)throw new Error(`Configuration validation failed: ${t.join(", ")}`);return e}getDefaultConfig(){return{...this.defaultConfig}}}class AnalyticsManager{constructor(){this.config=null,this.viewedThresholds=new Map,this.sessionData=new Map,this.trackingQueue=[],this.isTracking=!1}init(e,t){this.config=t,t.enabled&&(this.sessionData.set(e,{sessionId:this.generateSessionId(),startTime:Date.now(),totalPlayTime:0,seekCount:0,qualityChanges:0,maxProgress:0,events:[]}),this.startTrackingProcessor())}track(e,t){if(!this.config?.enabled)return;const i={eventType:e,playerId:t.playerId,timestamp:Date.now(),sessionId:this.sessionData.get(t.playerId)?.sessionId,...t,...this.getContextData()},s=this.sessionData.get(t.playerId);s&&(s.events.push(i),this.updateSessionStats(e,t,s)),this.trackingQueue.push(i),console.log(`Analytics: ${e}`,i)}trackProgress(e,t,i){if(!this.config?.enabled||!i)return;const s=t/i,n=this.sessionData.get(e);n&&(n.maxProgress=Math.max(n.maxProgress,s),s>=this.config.viewedThreshold&&!this.viewedThresholds.has(e)&&(this.viewedThresholds.set(e,!0),this.track("viewed_threshold_reached",{playerId:e,threshold:this.config.viewedThreshold,progress:s,currentTime:t,duration:i})))}updateSessionStats(e,t,i){switch(e){case"seek":i.seekCount++;break;case"quality_change":i.qualityChanges++;break;case"play":i.lastPlayTime=Date.now();break;case"pause":i.lastPlayTime&&(i.totalPlayTime+=Date.now()-i.lastPlayTime)}}getContextData(){return{cdn:this.config.cdn,isp:this.config.isp,geo:this.config.geo,videoId:this.config.videoId,playerSource:this.config.playerSource,userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},connection:this.getConnectionInfo()}}getConnectionInfo(){if("connection"in navigator){const e=navigator.connection;return{effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt,saveData:e.saveData}}return{}}startTrackingProcessor(){this.isTracking||(this.isTracking=!0,this.processTrackingQueue())}async processTrackingQueue(){for(;this.isTracking;){if(this.trackingQueue.length>0){const e=this.trackingQueue.splice(0,10);await this.sendEvents(e)}await this.sleep(1e3)}}async sendEvents(e){if(this.config.trackingUrl)try{const t=await fetch(this.config.trackingUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e,timestamp:Date.now()})});t.ok||console.warn("Analytics tracking failed:",t.status)}catch(t){console.error("Analytics tracking error:",t),this.trackingQueue.unshift(...e)}}generateSessionId(){return`${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getSessionData(e){return this.sessionData.get(e)}sleep(e){return new Promise(t=>setTimeout(t,e))}stopTracking(){this.isTracking=!1}cleanup(e){this.sessionData.delete(e),this.viewedThresholds.delete(e)}}class AdManager{constructor(){this.container=null,this.config=null,this.currentAd=null,this.adQueue=[],this.isPlayingAd=!1,this.adElement=null,this.skipButton=null}init(e,t){this.container=e,this.config=t,this.createAdContainer()}createAdContainer(){this.adContainer=document.createElement("div"),this.adContainer.className="up-ad-container",this.adContainer.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: #000;\n      display: none;\n      z-index: 1000;\n    ",this.container.appendChild(this.adContainer)}async playPreRoll(){return this.config.preRoll?this.playAd(this.config.preRoll,"preroll"):Promise.resolve()}async playPostRoll(){return this.config.postRoll?this.playAd(this.config.postRoll,"postroll"):Promise.resolve()}async playPauseRoll(){return this.config.pauseRoll?this.playAd(this.config.pauseRoll,"pauseroll"):Promise.resolve()}async playAd(e,t){return new Promise((i,s)=>{try{this.currentAd={config:e,type:t,startTime:Date.now(),resolve:i,reject:s},this.isPlayingAd=!0,this.showAdContainer(),this.createAdElement(e),this.createSkipButton(e),this.trackAdEvent("ad_start",{adType:t,adUrl:e.url,duration:e.duration})}catch(e){s(e)}})}createAdElement(e){this.adElement=document.createElement("video"),this.adElement.className="up-ad-video",this.adElement.style.cssText="\n      width: 100%;\n      height: 100%;\n      object-fit: contain;\n    ",this.adElement.src=e.url,this.adElement.muted=!1,this.adElement.controls=!1,this.adElement.addEventListener("loadeddata",()=>{this.adElement.play()}),this.adElement.addEventListener("ended",()=>{this.onAdEnded()}),this.adElement.addEventListener("error",e=>{this.onAdError(e)}),this.adElement.addEventListener("timeupdate",()=>{this.updateSkipButton()}),this.adContainer.appendChild(this.adElement)}createSkipButton(e){!1!==e.skippable&&(this.skipButton=document.createElement("button"),this.skipButton.className="up-ad-skip",this.skipButton.style.cssText="\n      position: absolute;\n      top: 20px;\n      right: 20px;\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      border: 1px solid #ccc;\n      padding: 8px 16px;\n      cursor: pointer;\n      border-radius: 4px;\n      font-size: 14px;\n      display: none;\n    ",this.skipButton.addEventListener("click",()=>{this.skipAd()}),this.adContainer.appendChild(this.skipButton))}updateSkipButton(){if(!this.skipButton||!this.adElement||!this.currentAd)return;const e=this.currentAd.config.skipAfter||5,t=this.adElement.currentTime;t>=e?(this.skipButton.style.display="block",this.skipButton.textContent="Skip Ad"):(this.skipButton.style.display="block",this.skipButton.textContent=`Skip in ${Math.ceil(e-t)}s`)}skipAd(){this.currentAd&&(this.trackAdEvent("ad_skip",{adType:this.currentAd.type,skipTime:this.adElement?.currentTime||0,duration:this.currentAd.config.duration}),this.onAdEnded())}onAdEnded(){this.currentAd&&(this.trackAdEvent("ad_complete",{adType:this.currentAd.type,playTime:this.adElement?.currentTime||0,duration:this.currentAd.config.duration}),this.cleanupAd(),this.currentAd.resolve(),this.currentAd=null)}onAdError(e){this.currentAd&&(this.trackAdEvent("ad_error",{adType:this.currentAd.type,error:e.message}),this.cleanupAd(),this.currentAd.reject(e),this.currentAd=null)}showAdContainer(){this.adContainer&&(this.adContainer.style.display="block")}hideAdContainer(){this.adContainer&&(this.adContainer.style.display="none")}cleanupAd(){this.isPlayingAd=!1,this.hideAdContainer(),this.adElement&&(this.adElement.pause(),this.adElement.remove(),this.adElement=null),this.skipButton&&(this.skipButton.remove(),this.skipButton=null)}trackAdEvent(e,t){console.log(`Ad Event: ${e}`,t),window.UniversalPlayer?.analyticsManager&&window.UniversalPlayer.analyticsManager.track(e,t)}isAdPlaying(){return this.isPlayingAd}destroy(){this.cleanupAd(),this.adContainer&&(this.adContainer.remove(),this.adContainer=null),this.container=null,this.config=null}}class UniversalPlayer{constructor(){return UniversalPlayer.instance?UniversalPlayer.instance:(this.version="1.0.0",this.instances=new Map,this.activePlayerId=null,this.eventManager=new EventManager,this.mediaFactory=new MediaFactory,this.configManager=new ConfigManager,this.analyticsManager=new AnalyticsManager,this.adManager=new AdManager,UniversalPlayer.instance=this,this)}init(e,t={}){const i="string"==typeof e?document.querySelector(e):e;if(!i)throw new Error(`Container not found: ${e}`);const s=this.generatePlayerId();t.container=i;const n=this.configManager.createConfig(t),a=new PlayerInstance({id:s,container:i,config:n,eventManager:this.eventManager,mediaFactory:this.mediaFactory,analyticsManager:this.analyticsManager,adManager:this.adManager});return this.instances.set(s,a),this.activePlayerId=s,a}getInstance(e){return this.instances.get(e)}getActiveInstance(){return this.instances.get(this.activePlayerId)}destroy(e){const t=this.instances.get(e);t&&(t.destroy(),this.instances.delete(e),this.activePlayerId===e&&(this.activePlayerId=this.instances.keys().next().value||null))}generatePlayerId(){return`up_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}class PlayerInstance{constructor({id:e,container:t,config:i,eventManager:s,mediaFactory:n,analyticsManager:a,adManager:r}){this.id=e,this.container=t,this.config=i,this.eventManager=s,this.mediaFactory=n,this.analyticsManager=a,this.adManager=r,this.state={currentTime:0,duration:0,volume:1,muted:!1,playing:!1,buffering:!1,fullscreen:!1,pip:!1,quality:"auto",playbackRate:1,seeking:!1},this.init()}async init(){try{this.uiManager=new UIManager({container:this.container,config:this.config,playerId:this.id}),this.mediaSource=this.mediaFactory.createMediaSource({url:this.config.videoUrl,type:this.config.mediaType,config:this.config}),this.setupEventListeners(),this.analyticsManager.init(this.id,this.config.eventTracking),this.config.adRolls&&this.adManager.init(this.container,this.config.adRolls),await this.uiManager.build(),await this.mediaSource.load(),this.applyInitialSettings(),this.eventManager.emit("player:ready",{playerId:this.id})}catch(e){console.error("Player initialization failed:",e),this.eventManager.emit("player:error",{playerId:this.id,error:e})}}setupEventListeners(){this.mediaSource.on("loadstart",()=>this.eventManager.emit("media:loadstart",{playerId:this.id})),this.mediaSource.on("canplay",()=>this.eventManager.emit("media:canplay",{playerId:this.id})),this.mediaSource.on("play",()=>this.handlePlay()),this.mediaSource.on("pause",()=>this.handlePause()),this.mediaSource.on("ended",()=>this.handleEnded()),this.mediaSource.on("timeupdate",e=>this.handleTimeUpdate(e)),this.mediaSource.on("volumechange",e=>this.handleVolumeChange(e)),this.mediaSource.on("seeking",()=>this.handleSeeking()),this.mediaSource.on("seeked",()=>this.handleSeeked()),this.mediaSource.on("error",e=>this.handleError(e)),this.uiManager.on("ui:play",()=>this.play()),this.uiManager.on("ui:pause",()=>this.pause()),this.uiManager.on("ui:seek",e=>this.seek(e.time)),this.uiManager.on("ui:volume",e=>this.setVolume(e.volume)),this.uiManager.on("ui:mute",()=>this.toggleMute()),this.uiManager.on("ui:fullscreen",()=>this.toggleFullscreen()),this.uiManager.on("ui:pip",()=>this.togglePictureInPicture()),this.uiManager.on("ui:speed",e=>this.setPlaybackRate(e.rate)),this.uiManager.on("ui:quality",e=>this.setQuality(e.quality))}applyInitialSettings(){this.config.startOffset&&this.seek(this.config.startOffset),this.config.autoplay&&this.play(),void 0!==this.config.volume&&this.setVolume(this.config.volume)}async play(){try{await this.mediaSource.play(),this.state.playing=!0,this.analyticsManager.track("play",{playerId:this.id,currentTime:this.state.currentTime})}catch(e){console.error("Play failed:",e),this.eventManager.emit("player:error",{playerId:this.id,error:e})}}pause(){this.mediaSource.pause(),this.state.playing=!1,this.analyticsManager.track("pause",{playerId:this.id,currentTime:this.state.currentTime})}seek(e){this.mediaSource.seek(e),this.analyticsManager.track("seek",{playerId:this.id,from:this.state.currentTime,to:e})}setVolume(e){this.mediaSource.setVolume(e),this.state.volume=e,this.state.muted=0===e}toggleMute(){const e=!this.state.muted;this.mediaSource.setMuted(e),this.state.muted=e}setPlaybackRate(e){this.mediaSource.setPlaybackRate(e),this.state.playbackRate=e}setQuality(e){this.mediaSource.setQuality(e),this.state.quality=e,this.analyticsManager.track("quality_change",{playerId:this.id,quality:e})}toggleFullscreen(){document.fullscreenElement?(document.exitFullscreen(),this.state.fullscreen=!1):(this.container.requestFullscreen(),this.state.fullscreen=!0),this.analyticsManager.track("fullscreen",{playerId:this.id,fullscreen:this.state.fullscreen})}togglePictureInPicture(){this.config.pip.enabled&&this.mediaSource.supportsPiP()&&(this.mediaSource.togglePictureInPicture(),this.state.pip=!this.state.pip)}handlePlay(){this.state.playing=!0,this.uiManager.updatePlayButton(!0),this.eventManager.emit("player:play",{playerId:this.id})}handlePause(){this.state.playing=!1,this.uiManager.updatePlayButton(!1),this.eventManager.emit("player:pause",{playerId:this.id})}handleEnded(){this.state.playing=!1,this.uiManager.updatePlayButton(!1),this.eventManager.emit("player:ended",{playerId:this.id}),this.analyticsManager.track("ended",{playerId:this.id}),this.config.nextVideo&&this.config.nextVideo.url&&this.loadVideo(this.config.nextVideo.url)}handleTimeUpdate({currentTime:e,duration:t}){this.state.currentTime=e,this.state.duration=t,this.uiManager.updateProgress(e,t),this.analyticsManager.trackProgress(this.id,e,t)}handleVolumeChange({volume:e,muted:t}){this.state.volume=e,this.state.muted=t,this.uiManager.updateVolume(e,t)}handleSeeking(){this.state.seeking=!0,this.uiManager.showBuffering(!0)}handleSeeked(){this.state.seeking=!1,this.uiManager.showBuffering(!1)}handleError(e){console.error("Media error:",e),this.eventManager.emit("player:error",{playerId:this.id,error:e})}loadVideo(e){this.mediaSource.loadUrl(e)}getState(){return{...this.state}}destroy(){this.mediaSource?.destroy(),this.uiManager?.destroy(),this.adManager?.destroy(),this.container.innerHTML=""}}const universalPlayer=new UniversalPlayer;"undefined"!=typeof window&&(window.UniversalPlayer=universalPlayer);